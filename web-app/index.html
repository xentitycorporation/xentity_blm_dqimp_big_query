<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waterfall Month-to-Month</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { padding: 12px; }
    #chart { width: 100%; height: 80vh; }
    .note { font-size: 12px; opacity: 0.75; margin-top: 6px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="chart"></div>
    <div class="note">
      Tip: replace the CSV monthly (same filename/path) and the chart updates automatically.
    </div>
  </div>

  <script>
    // ✅ Update if your filename/path changes
    // For LOCAL testing (recommended): const CSV_URL = "./Waterfall_Counts_Decimal.csv";
    const CSV_URL =
      "https://raw.githubusercontent.com/xentitycorporation/xentity_blm_dqimp_big_query/main/web-app/Waterfall_Counts_Decimal.csv";

    function parseNumber(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    function fmt(n) {
      const num = Number(n) || 0;
      return num.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    // 20260101 -> "2026-01"
    function monthLabel(m) {
      const s = String(m);
      const yyyy = s.slice(0, 4);
      const mm = s.slice(4, 6);
      return `${yyyy}-${mm}`;
    }

    function isSnapshot(typeStr) {
      return String(typeStr || "").toLowerCase().includes("snapshot");
    }

    function niceTypeLabel(typeStr) {
      const t = String(typeStr || "").trim();
      const lower = t.toLowerCase();
      if (lower.includes("fixed")) return "Fixes";
      if (lower.includes("newly")) return "Newly Out-of-Sync";
      return t; // fallback
    }

    function render(rowsRaw) {
      // Normalize + enforce Sort ordering
      const rows = rowsRaw
        .filter(r => r.Sort != null && r.Type != null && r.Value != null)
        .map(r => ({
          Month: parseNumber(r.Month),
          Type: String(r.Type).trim(),
          Value: parseNumber(r.Value),
          Sort: parseNumber(r.Sort),
        }))
        .sort((a, b) => a.Sort - b.Sort);

      if (!rows.length) {
        Plotly.newPlot("chart", [{
          type: "scatter",
          x: [0], y: [0],
          mode: "text",
          text: ["No rows found. Check CSV columns: Month, Type, Value, Sort."]
        }], { title: "Waterfall" }, { responsive: true });
        return;
      }

      const x = [];
      const y = [];
      const measure = [];
      const text = [];

      let seenFirstSnapshot = false;

      for (const r of rows) {
        const snap = isSnapshot(r.Type);

        // X label: snapshot gets month label, others get the type label
        const xLabel = snap ? monthLabel(r.Month) : niceTypeLabel(r.Type);

        // Measure rules:
        // - first snapshot => absolute
        // - later snapshots => total
        // - everything else => relative
        let m;
        if (snap) {
          m = seenFirstSnapshot ? "total" : "absolute";
          seenFirstSnapshot = true;
        } else {
          m = "relative";
        }

        x.push(xLabel);
        y.push(r.Value);
        measure.push(m);

        // Text label formatting
        if (snap) {
          text.push(fmt(r.Value));
        } else {
          text.push(r.Value >= 0 ? `+${fmt(r.Value)}` : `-${fmt(Math.abs(r.Value))}`);
        }
      }

      const wf = {
        type: "waterfall",
        x,
        y,
        measure,
        text,
        textposition: "outside",
        cliponaxis: false,
        hovertemplate: "<b>%{x}</b><br>Value: %{text}<extra></extra>",
        connector: { line: { width: 1 } },
        marker: {
          increasing: { color: "#d62728" }, // red (positive deltas = newly out-of-sync)
          decreasing: { color: "#2ca02c" }, // green (negative deltas = fixes)
          totals:     { color: "#1f77b4" }  // blue (snapshots)
        },
        showlegend: false
      };

      // Dummy legend items so the legend matches your reference image
      const legendSnapshot = {
        type: "scatter",
        mode: "markers",
        x: [null], y: [null],
        marker: { size: 12, color: "#1f77b4" },
        name: "Snapshot Total (Blue)",
        hoverinfo: "skip"
      };

      const legendFixes = {
        type: "scatter",
        mode: "markers",
        x: [null], y: [null],
        marker: { size: 12, color: "#2ca02c" },
        name: "Fixed Cases (Green)",
        hoverinfo: "skip"
      };

      const legendNewly = {
        type: "scatter",
        mode: "markers",
        x: [null], y: [null],
        marker: { size: 12, color: "#d62728" },
        name: "Newly Out-of-Sync (Red)",
        hoverinfo: "skip"
      };

      const layout = {
        title: "Waterfall of Sync Errors Month to Month",
        margin: { t: 70, r: 20, b: 130, l: 70 },
        yaxis: { title: "Count" },
        xaxis: {
          type: "category",      // ✅ force categorical x-axis (prevents 20.26M nonsense)
          automargin: true,
          tickangle: -30
        },
        legend: {
          orientation: "h",
          x: 0,
          y: -0.25
        }
      };

      Plotly.newPlot("chart", [wf, legendSnapshot, legendFixes, legendNewly], layout, { responsive: true });
    }

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: (results) => render(results.data),
      error: (err) => {
        console.error(err);
        Plotly.newPlot("chart", [{
          type: "scatter",
          x: [0], y: [0],
          mode: "text",
          text: ["Failed to load CSV. Check CSV_URL / permissions / filename."]
        }], { title: "Waterfall" }, { responsive: true });
      }
    });
  </script>
</body>
</html>
