<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waterfall Month-to-Month</title>

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { padding: 12px; }
    #chart { width: 100%; height: 80vh; }
    .note { font-size: 12px; opacity: 0.75; margin-top: 6px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="chart"></div>
    <div class="note">
      Tip: replace the CSV monthly (same filename/path) and the chart updates automatically.
    </div>
  </div>

  <script>
    // For LOCAL testing, use:
    // const CSV_URL = "./Waterfall_Counts_Decimal.csv";

    // For GitHub-hosted CSV, use:
    const CSV_URL =
      "https://raw.githubusercontent.com/xentitycorporation/xentity_blm_dqimp_big_query/main/web-app/Waterfall_Counts_Decimal.csv";

    function parseNumber(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    function fmt(n) {
      const num = Number(n) || 0;
      return num.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    // 20260101 -> "2026-01"
    function monthLabel(m) {
      const s = String(m);
      const yyyy = s.slice(0, 4);
      const mm = s.slice(4, 6);
      return `${yyyy}-${mm}`;
    }

    function lower(s) { return String(s || "").toLowerCase(); }
    function isSnapshot(typeStr) { return lower(typeStr).includes("snapshot"); }
    function isFixed(typeStr) { return lower(typeStr).includes("fixed"); }
    function isNewly(typeStr) { return lower(typeStr).includes("newly"); }

    function displayLabel(row) {
      if (isSnapshot(row.Type)) return monthLabel(row.Month);
      if (isFixed(row.Type)) return "Fixes";
      if (isNewly(row.Type)) return "Newly Out-of-Sync";
      return String(row.Type || "").trim();
    }

    function render(rowsRaw) {
      // Normalize rows and sort strictly by Sort (your authoritative order)
      const rows = rowsRaw
        .filter(r => r.Sort != null && r.Type != null && r.Value != null)
        .map(r => ({
          Month: parseNumber(r.Month),
          Type: String(r.Type).trim(),
          Value: parseNumber(r.Value),
          Sort: parseNumber(r.Sort)
        }))
        .sort((a, b) => a.Sort - b.Sort);

      if (!rows.length) {
        Plotly.newPlot("chart", [{
          type: "scatter", x: [0], y: [0], mode: "text",
          text: ["No rows found. Check CSV columns: Month, Type, Value, Sort."]
        }], { title: "Waterfall" }, { responsive: true });
        return;
      }

      // Build unique x positions so repeated labels don't collapse
      const x = rows.map(r => `s${r.Sort}`);               // unique IDs
      const tickvals = [...x];
      const ticktext = rows.map(r => displayLabel(r));     // what the user sees

      const y = [];
      const measure = [];
      const text = [];

      let firstSnapshotSeen = false;

      for (const r of rows) {
        let v = r.Value;

        // Optional safety: enforce sign conventions:
        // Fixes should reduce total (negative), Newly should increase (positive).
        if (isFixed(r.Type) && v > 0) v = -v;
        if (isNewly(r.Type) && v < 0) v = Math.abs(v);

        y.push(v);

        if (isSnapshot(r.Type)) {
          measure.push(firstSnapshotSeen ? "total" : "absolute");
          firstSnapshotSeen = true;
          text.push(fmt(v));
        } else {
          measure.push("relative");
          text.push(v >= 0 ? `+${fmt(v)}` : `-${fmt(Math.abs(v))}`);
        }
      }

      const wf = {
        type: "waterfall",
        x,
        y,
        measure,
        text,
        textposition: "outside",
        cliponaxis: false,
        hovertemplate:
          "<b>%{customdata}</b><br>" +
          "Value: %{text}<extra></extra>",
        customdata: ticktext, // show friendly label on hover
        connector: { line: { width: 1 } },
        marker: {
          increasing: { color: "#d62728" }, // red = increases (Newly Out-of-Sync)
          decreasing: { color: "#2ca02c" }, // green = decreases (Fixes)
          totals:     { color: "#1f77b4" }  // blue = snapshot totals
        },
        showlegend: false
      };

      // Legend items (dummy traces)
      const legendSnapshot = {
        type: "scatter", mode: "markers",
        x: [null], y: [null],
        marker: { size: 12, color: "#1f77b4" },
        name: "Snapshot Total (Blue)",
        hoverinfo: "skip"
      };

      const legendFixes = {
        type: "scatter", mode: "markers",
        x: [null], y: [null],
        marker: { size: 12, color: "#2ca02c" },
        name: "Fixed Cases (Green)",
        hoverinfo: "skip"
      };

      const legendNewly = {
        type: "scatter", mode: "markers",
        x: [null], y: [null],
        marker: { size: 12, color: "#d62728" },
        name: "Newly Out-of-Sync (Red)",
        hoverinfo: "skip"
      };

      const layout = {
        title: "Waterfall of Sync Errors Month to Month",
        margin: { t: 70, r: 20, b: 150, l: 70 },
        yaxis: { title: "Count" },
        xaxis: {
          type: "c
